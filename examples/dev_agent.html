<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dev Agent</title>
    <style>
      body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 20px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      input, textarea, button { font-size: 14px; }
      input[type=text] { width: 520px; padding:8px; }
      textarea { width: 100%; height: 200px; font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }
      .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-bottom:16px; }
      .muted { color:#6b7280; font-size:12px; }
      .ok { color:#10b981; }
      .err { color:#ef4444; }
    </style>
  </head>
  <body>
    <h1>Dev Agent</h1>
    <p class="muted">ローカルのファイル/URLを投げて、ステージ/コミット/プッシュを手早く。</p>

    <section class="card">
      <div class="row">
        <input id="url" type="text" placeholder="file:///Users/you/path/to/file.txt または /Users/you/file.txt" />
        <button id="handle">Handle URL/Path</button>
      </div>
      <div id="handleOut" class="muted" style="margin-top:6px;"></div>
    </section>

    <section class="card">
      <h3>HTML 作業ファイル</h3>
      <div class="row" style="margin-top:6px;">
        <input id="htmlPath" type="text" placeholder="/Users/you/work/page.html または file:///.../page.html" style="width:520px" />
        <input id="htmlTitle" type="text" placeholder="Page title" style="width:220px" />
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ensureHtml">Create/Open</button>
        <button id="stageHtml">git add to repo</button>
        <span id="htmlOut" class="muted"></span>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <input id="paths" type="text" placeholder="スペース区切りで複数パス /Users/you/a /Users/you/b" />
        <button id="add">git add</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="repo" type="text" placeholder="repo path (省略時はこのリポジトリ)" style="width: 300px;" />
        <input id="msg" type="text" placeholder="commit message (省略時: chore: update)" style="width: 300px;" />
        <button id="commit">commit</button>
        <button id="push">push origin main</button>
      </div>
      <pre id="status" class="muted" style="margin-top:8px; white-space:pre-wrap"></pre>
    </section>

    <script>
      const $ = s => document.querySelector(s);
      async function post(path, body) {
        const r = await fetch(path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return await r.json();
      }
      function repoArg() { const v = $('#repo').value.trim(); return v ? {repo:v} : {}; }
      async function refresh() {
        try {
          const s = await post('/api/git/status', repoArg());
          $('#status').textContent = `cwd: ${s.cwd}\nbranch: ${s.branch}\n\n${s.status || ''}\n${s.remote || ''}`;
        } catch (e) {
          $('#status').textContent = `err: ${e.message}`;
        }
      }
      async function handle() {
        const url = $('#url').value.trim(); if (!url) return;
        const res = await post('/api/handle_url', {url, ...repoArg()});
        if (res.action === 'staged') {
          $('#handleOut').textContent = `staged: ${res.path}`; $('#handleOut').className = 'ok';
        } else if (res.action === 'external') {
          $('#handleOut').textContent = `external: ${res.url}`; $('#handleOut').className = 'muted';
        } else {
          $('#handleOut').textContent = `no action`; $('#handleOut').className = 'muted';
        }
        await refresh();
      }
      async function add() {
        const v = $('#paths').value.trim(); if (!v) return;
        const parts = v.split(/\s+/);
        const res = await post('/api/git/add', {paths: parts, ...repoArg()});
        $('#handleOut').textContent = `added: ${(res.added||[]).join(', ')}`; $('#handleOut').className = 'ok';
        await refresh();
      }
      async function commit() {
        const msg = $('#msg').value.trim();
        const res = await post('/api/git/commit', {message: msg, ...repoArg()});
        $('#handleOut').textContent = (res.output||'').trim(); $('#handleOut').className = 'muted';
        await refresh();
      }
      async function push() {
        const res = await post('/api/git/push', {remote:'origin', branch:'main', ...repoArg()});
        $('#handleOut').textContent = (res.output||'').trim(); $('#handleOut').className = 'muted';
        await refresh();
      }

      // HTML helpers
      async function ensureHtml() {
        const path = $('#htmlPath').value.trim(); if (!path) return;
        const title = $('#htmlTitle').value.trim() || 'My Page';
        const res = await post('/api/file/ensure_html', {path, title, open:true});
        $('#htmlOut').textContent = `${res.created ? 'created' : 'exists'}: ${res.file_url}`;
        $('#htmlOut').className = res.created ? 'ok' : 'muted';
      }
      async function stageHtml() {
        const path = $('#htmlPath').value.trim(); if (!path) return;
        const res = await post('/api/git/add', {paths:[path], ...repoArg()});
        $('#htmlOut').textContent = `staged: ${(res.added||[]).join(', ')}`; $('#htmlOut').className = 'ok';
        await refresh();
      }

      window.addEventListener('load', () => {
        $('#handle').addEventListener('click', handle);
        $('#ensureHtml').addEventListener('click', ensureHtml);
        $('#stageHtml').addEventListener('click', stageHtml);
        $('#add').addEventListener('click', add);
        $('#commit').addEventListener('click', commit);
        $('#push').addEventListener('click', push);
        refresh();
      });
    </script>
  </body>
  </html>
