<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Remote Dev Agent (No Local API)</title>
    <style>
      body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 20px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      input, textarea, button { font-size: 14px; }
      input[type=text], input[type=password] { width: 520px; padding:8px; }
      textarea { width: 100%; height: 220px; font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }
      .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-bottom:16px; }
      .muted { color:#6b7280; font-size:12px; }
      .ok { color:#10b981; }
      .err { color:#ef4444; }
      .hint { color:#64748b; font-size:12px; }
    </style>
  </head>
  <body>
    <h1>Remote Dev Agent</h1>
    <p class="muted">ローカルAPIなしで、GitHub APIだけでコミット/プッシュします。トークンは入力中のみ使用し保存しません。</p>

    <section class="card">
      <div class="row">
        <input id="owner" type="text" placeholder="owner（例: attrip）" />
        <input id="repo" type="text" placeholder="repo（例: xxx）" />
        <input id="branch" type="text" placeholder="branch（既定: main）" value="main" />
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="path" type="text" placeholder="path in repo（例: workbench/index.html）」 style="width: 640px;" />
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="message" type="text" placeholder="commit message" style="width: 640px;" value="chore: update via Remote Dev Agent" />
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="token" type="password" placeholder="GitHub Token（repo 権限が必要）" />
        <span class="hint">表示はしません。保存もしません。</span>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <input id="file" type="file" />
        <span class="muted">または下のテキストに直接貼り付け</span>
      </div>
      <textarea id="content" placeholder="ここにファイル内容を貼り付けるか、上でファイルを選択"></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="commit">Commit + Push（Enter）</button>
        <span id="out" class="muted"></span>
      </div>
    </section>

    <script>
      const $ = (s) => document.querySelector(s);

      function b64encode(str) { return btoa(unescape(encodeURIComponent(str))); }
      function b64decode(b64) { return decodeURIComponent(escape(atob(b64))); }
      function headers(token) {
        return { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` };
      }
      async function getFileSHA(owner, repo, path, branch, token) {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
        const r = await fetch(url, { headers: headers(token) });
        if (r.status === 404) return null; // new file
        if (!r.ok) throw new Error(`GET ${r.status}`);
        const j = await r.json();
        return j.sha || null;
      }
      async function putFile(owner, repo, path, branch, message, content, token, sha) {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
        const body = { message, content: b64encode(content), branch };
        if (sha) body.sha = sha;
        const r = await fetch(url, { method: 'PUT', headers: { ...headers(token), 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!r.ok) {
          const t = await r.text();
          throw new Error(`PUT ${r.status}: ${t}`);
        }
        return await r.json();
      }

      async function run() {
        const owner = $('#owner').value.trim();
        const repo  = $('#repo').value.trim();
        const branch= ($('#branch').value.trim() || 'main');
        const path  = $('#path').value.trim();
        const msg   = $('#message').value.trim();
        const token = $('#token').value.trim();
        let content = $('#content').value;
        if (!content) { $('#out').textContent = '内容が空です'; return; }
        if (!owner || !repo || !path || !msg || !token) { $('#out').textContent = '入力を確認してください'; return; }
        $('#out').textContent = 'checking…';
        const sha = await getFileSHA(owner, repo, path, branch, token);
        $('#out').textContent = 'pushing…';
        const res = await putFile(owner, repo, path, branch, msg, content, token, sha);
        const link = res && res.content && res.content.html_url ? res.content.html_url : '';
        $('#out').innerHTML = `done ${link ? '· <a href="' + link + '" target="_blank">view</a>' : ''}`;
        $('#out').className = 'ok';
      }

      $('#file').addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const text = await f.text(); $('#content').value = text;
        if (!$('#path').value) $('#path').value = f.name;
      });
      $('#commit').addEventListener('click', run);
      document.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) { e.preventDefault(); run(); } });
    </script>
  </body>
  </html>
